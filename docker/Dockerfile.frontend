FROM node:20-alpine AS builder

WORKDIR /app

# Clear npm cache to ensure fresh installs
RUN npm cache clean --force

# Copy frontend package files including lock file
COPY packages/web/package.json ./
COPY packages/web/package-lock.json* ./

# Copy zurto-ui library for local dependency resolution
COPY packages/ui /zurto-ui

# Build zurto-ui first
WORKDIR /zurto-ui
RUN npm install && npm run build

# Back to app directory
WORKDIR /app

# Install dependencies with clean cache and exact versions
RUN npm install --legacy-peer-deps

# Copy source files AFTER npm install (better caching)
COPY packages/web/src ./src
COPY packages/web/public ./public
COPY packages/web/tsconfig.json ./
COPY packages/web/vite.config.ts ./
COPY packages/web/index.html ./

# Build args for Vite (baked at build time)
ARG VITE_API_URL=https://api.zurto.app
ARG VITE_SOCKET_URL=wss://api.zurto.app
ENV VITE_API_URL=$VITE_API_URL
ENV VITE_SOCKET_URL=$VITE_SOCKET_URL

# Build
RUN npm run build

# Production image
FROM node:20-alpine

WORKDIR /app

# Install serve to run the app
RUN npm install -g serve

# Copy built application from builder
COPY --from=builder /app/dist ./dist

# Expose port
EXPOSE 5173

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD wget -q --spider http://localhost:5173 || exit 1

# Start the application
CMD ["serve", "-s", "dist", "-l", "5173"]
